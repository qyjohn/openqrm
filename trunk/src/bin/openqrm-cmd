#!/bin/bash
# this is the openQRM commandline client

export PATH=$PATH:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/X11R6/bin

if [ "$OPENQRM_SERVER_BASE_DIR" == "" ]; then
	OPENQRM_SERVER_BASE_DIR=$(dirname $0)/../..
	OPENQRM_SERVER_BASE_DIR=$(pushd $OPENQRM_SERVER_BASE_DIR > /dev/null && echo $PWD && popd > /dev/null)
fi
export OPENQRM_SERVER_BASE_DIR
# check if running on the server or on a managed resource
if [ -f "$OPENQRM_SERVER_BASE_DIR/openqrm/include/openqrm-server-functions" ]; then
	# we are running on the server
	. $OPENQRM_SERVER_BASE_DIR/openqrm/include/openqrm-functions
	. $OPENQRM_SERVER_BASE_DIR/openqrm/include/openqrm-server-functions
else
	# we are running on a managed resource
	. $OPENQRM_SERVER_BASE_DIR/openqrm/include/openqrm-functions
	. $OPENQRM_RESOURCE_PARAMETER_FILE
fi

WHOAMI=`whoami`
echo "openQRM engine: Running as $WHOAMI cmd : $@" | logger

function stop_openqrm_monitord() {
	killall openqrm-monitord 1>/dev/null 2>&1
	# in case we do not have killall (e.g. on debian-minimal install) be sure to stop the openqrm-agents anyway
	for OPENQRM_PID in `ps ax 2>/dev/null | grep openqrm-monitord | grep -v grep | awk {' print $1 '}`; do
		kill $OPENQRM_PID
	done
}


case "$@" in
	reboot)
		stop_openqrm_monitord
		/sbin/reboot
		exit 0
		;;
	halt)
		stop_openqrm_monitord
		/sbin/halt -f
		exit 0
		;;
esac

$@ 2>&1 | logger
