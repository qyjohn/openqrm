#!/bin/bash
# this is the openQRM commandline client

if [ "$OPENQRM_SERVER_BASE_DIR" == "" ]; then
	OPENQRM_SERVER_BASE_DIR=$(dirname $0)/../..
	OPENQRM_SERVER_BASE_DIR=$(pushd $OPENQRM_SERVER_BASE_DIR > /dev/null && echo $PWD && popd > /dev/null)
fi
. $OPENQRM_SERVER_BASE_DIR/openqrm/include/openqrm-functions
. $OPENQRM_SERVER_BASE_DIR/openqrm/include/openqrm-server-functions


function openqrm_usage() {
	echo
	echo "Usage:"
	echo "`basename $0` help			- This help screen"
	echo
	echo "- Managing boot-images -"
	echo "`basename $0` kernel add -n <name> -v <version> -u <username> -p <password> [-l <location> -i <initramfs/ext2> -t <path-to-initrd-template-file>]"
	echo "`basename $0` kernel remove -n <name> -u <username> -p <password>"
	echo
	echo "- Managing server-states -"
	echo "`basename $0` state backup -n <name>"
	echo "`basename $0` state restore -n <name>"
	echo "`basename $0` state remove -n <name>"
	echo "`basename $0` state list"
	echo


}



# main
case "$1" in
	kernel)
		shift
		if [ $# == 0 ]; then
			openqrm_usage
			exit 0
		fi

		case "$1" in
			add)
				shift
				if [ $# == 0 ]; then
					openqrm_usage
					exit 0
				fi
				while [ $# -ne 0 ]; do
					case "$1" in
						-n)
							BOOT_IMAGE_NAME=$2
							shift
							;;
						-v)
							BOOT_IMAGE_VERSION=$2
							shift
							;;			
						-l)
							BOOT_IMAGE_LOCATION=$2
							shift
							;;
						-i)
							BOOT_IMAGE_INITRD_TYPE=$2
							shift
							;;
						-t)
							BOOT_IMAGE_INITRD_TEMPLATE=$2
							shift
							;;
						-u)
							OPENQRM_USERNAME=$2
							shift
							;;
						-p)
							OPENQRM_PASSWORD=$2
							shift
							;;
					esac
					shift
				done
				if [ "$BOOT_IMAGE_NAME" == "" ] || [ "$BOOT_IMAGE_VERSION" == "" ] || [ "$OPENQRM_USERNAME" == "" ] || [ "$OPENQRM_PASSWORD" == "" ]; then
					openqrm_usage
					exit 1
				fi
				if [ "$BOOT_IMAGE_LOCATION" == "" ]; then
					BOOT_IMAGE_LOCATION=/
				fi
				if [ "$BOOT_IMAGE_INITRD_TYPE" == "" ]; then
					BOOT_IMAGE_INITRD_TYPE="initramfs"
				fi
				if [ "$BOOT_IMAGE_INITRD_TEMPLATE" == "" ]; then
					BOOT_IMAGE_INITRD_TEMPLATE=$OPENQRM_DEFAULT_INITRD_TEMPLATE
				fi
				openqrm_server_create_kernel $BOOT_IMAGE_NAME $BOOT_IMAGE_VERSION $BOOT_IMAGE_LOCATION $BOOT_IMAGE_INITRD_TYPE $BOOT_IMAGE_INITRD_TEMPLATE
				if ! openqrm_server_manage_kernel add $OPENQRM_USERNAME $OPENQRM_PASSWORD $BOOT_IMAGE_NAME $BOOT_IMAGE_VERSION; then
					echo "WARNING: Could not add the kernel to the openQRM-server!"
					exit -1
				fi
				;;

			remove)
				shift
				if [ $# == 0 ]; then
					openqrm_usage
					exit 0
				fi
				while [ $# -ne 0 ]; do
					case "$1" in
						-n)
							BOOT_IMAGE_NAME=$2
							shift
							;;
						-u)
							OPENQRM_USERNAME=$2
							shift
							;;
						-p)
							OPENQRM_PASSWORD=$2
							shift
							;;
					esac
					shift
				done
				if [ "$BOOT_IMAGE_NAME" == "" ] || [ "$OPENQRM_USERNAME" == "" ] || [ "$OPENQRM_PASSWORD" == "" ]; then
					openqrm_usage
					exit 1
				fi
				rm -f $OPENQRM_SERVER_BASE_DIR/openqrm/tftpboot/boot/vmlinuz-$BOOT_IMAGE_NAME
				rm -f $OPENQRM_SERVER_BASE_DIR/openqrm/tftpboot/boot/System.map-$BOOT_IMAGE_NAME
				rm -f $OPENQRM_SERVER_BASE_DIR/openqrm/tftpboot/boot/modules-$BOOT_IMAGE_NAME.tgz
				rm -f $OPENQRM_SERVER_BASE_DIR/openqrm/tftpboot/boot/initrd-$BOOT_IMAGE_NAME.img
				if ! openqrm_server_manage_kernel remove $OPENQRM_USERNAME $OPENQRM_PASSWORD $BOOT_IMAGE_NAME $BOOT_IMAGE_VERSION; then
					echo "WARNING: Could not remove the kernel to the openQRM-server!"
					exit -1
				fi
				;;

		esac
		;;


	state)
		shift
		if [ $# == 0 ]; then
			openqrm_usage
			exit 0
		fi
		export OPENQRM_SERVER_BASE_DIR

		case "$1" in
			backup)
				shift
				if [ $# == 0 ]; then
					openqrm_usage
					exit 0
				fi
				while [ $# -ne 0 ]; do
					case "$1" in
						-n)
							BACKUP_STATE_NAME=$2
							shift
							;;
					esac
					shift
				done
				if [ "$BACKUP_STATE_NAME" == "" ]; then
					openqrm_usage
					exit 1
				fi
				openqrm_server_state backup $BACKUP_STATE_NAME
				;;

			restore)
				shift
				if [ $# == 0 ]; then
					openqrm_usage
					exit 0
				fi
				while [ $# -ne 0 ]; do
					case "$1" in
						-n)
							BACKUP_STATE_NAME=$2
							shift
							;;
					esac
					shift
				done
				if [ "$BACKUP_STATE_NAME" == "" ]; then
					openqrm_usage
					exit 1
				fi
				openqrm_server_state restore $BACKUP_STATE_NAME
				;;

			remove)
				shift
				if [ $# == 0 ]; then
					openqrm_usage
					exit 0
				fi
				while [ $# -ne 0 ]; do
					case "$1" in
						-n)
							BACKUP_STATE_NAME=$2
							shift
							;;
					esac
					shift
				done
				if [ "$BACKUP_STATE_NAME" == "" ]; then
					openqrm_usage
					exit 1
				fi
				openqrm_server_state remove $BACKUP_STATE_NAME
				;;

			list)
				openqrm_server_state list
				;;



		esac
		;;


	*)
		openqrm_usage
		;;

esac


