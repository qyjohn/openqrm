#!/bin/bash

# this script automatically manages windows
OPENQRM_SERVER_BASE_DIR=$(dirname $0)/../../../..
OPENQRM_SERVER_BASE_DIR=$(pushd $OPENQRM_SERVER_BASE_DIR > /dev/null && echo $PWD && popd > /dev/null)
. $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/windows/etc/openqrm-plugin-windows.conf
. $OPENQRM_SERVER_BASE_DIR/openqrm/include/openqrm-functions
. $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/windows/include/openqrm-plugin-windows-functions
. $OPENQRM_SERVER_BASE_DIR/openqrm/etc/openqrm-server.conf
. $OPENQRM_SERVER_BASE_DIR/openqrm/include/openqrm-server-functions
openqrm_server_get_config
export LANG=C
export resource_openqrmserver=$OPENQRM_SERVER_IP_ADDRESS


# let only root run this script
WHOAMI=`whoami`
if [ "$WHOAMI" != "root" ]; then
	echo "ERROR: Please run this script as root!"
	exit 6
fi

function windows_usage() {
	echo "Usage : $0 start/stop/reboot <-s windows-server-ip>"
	exit 1
}


WINDOWS_COMMAND=$1
shift

while [ $# -ne 0 ]; do
	case "$1" in
		-n)
			WINDOWS_VM_UUID=$2
			shift
			;;
		-s)
			WINDOWS_SERVER_IP=$2
			shift
			;;
		-l)
			WINDOWS_VM_NAME=$2
			shift
			;;
		-m)
			WINDOWS_VM_RAM=$2
			shift
			;;
		*)
			echo "ERROR: Free commandline arguments are not allowed"
			windows_usage
			exit 6
			;;
	esac
	shift
done


# main
if [ "$WINDOWS_COMMAND" == "" ]; then
	windows_usage
fi

if [ "$WINDOWS_SERVER_IP" == "" ]; then
	windows_usage
fi

WINDOWS_SERVER_PASSWD_FILE=$OPENQRM_SERVER_BASE_DIR/openqrm/plugins/windows/web/windows-stat/windows-host.pwd.$WINDOWS_SERVER_IP

if [ ! -f $WINDOWS_SERVER_PASSWD_FILE ]; then
	windows_log openqrm-windows "No password file ($WINDOWS_SERVER_PASSWD_FILE) existing for Citrix host $WINDOWS_SERVER_IP"
	openqrm_post_event 0 "$WINDOWS_COMMAND" 3 "openqrm-windows" "No password file ($WINDOWS_SERVER_PASSWD_FILE) existing for Citrix host $WINDOWS_SERVER_IP"
	exit 1
fi

case "$WINDOWS_COMMAND" in 

	start)
		echo "Starting $WINDOWS_VM_UUID"
		echo "Ey dude - how should I do this"
		;;
	stop)
		echo "Stopping Citrix vm $WINDOWS_VM_UUID"
		net rpc shutdown -f -C "Puh - Shutting Down Windows" -U "thohal%secret" -I $WINDOWS_SERVER_IP 
		;;
	reboot)
		echo "Listing Citrix vms"
		net rpc shutdown -f -r -C "Puh - Shutting Down Windows" -U "thohal%secret" -I $WINDOWS_SERVER_IP
		;;
	*)
		windows_usage
		;;


esac

