#!/usr/bin/expect -f
#
# this is an expect script to automatically run commands on a equallogic-filer
#
#
# This file is part of openQRM.
#
# openQRM is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2
# as published by the Free Software Foundation.
#
# openQRM is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with openQRM.  If not, see <http://www.gnu.org/licenses/>.
#
# Copyright 2009, Matthias Rechenburg <matt@openqrm.com>
#

if {[llength $argv]<2} {
        send_user "usage: $argv0 <equallogic-ip> <equallogic-user> <equallogic-password> <volume-name> <access-id>\n"
        exit
}

set EQUALLOGIC_IP [lindex $argv 0]
set EQUALLOGIC_USER [lindex $argv 1]
set EQUALLOGIC_PASSWORD [lindex $argv 2]
set EQUALLOGIC_VOLUME [lindex $argv 3]
set EQUALLOGIC_VOLUME_ACCESS_ID [lindex $argv 4]

send_user "Removing access id $EQUALLOGIC_VOLUME_ACCESS_ID for volume $EQUALLOGIC_VOLUME on $EQUALLOGIC_IP as $EQUALLOGIC_USER\n"

set force_conservative 0  ;# set to 1 to force conservative mode even if
                          ;# script wasn't run conservatively originally
if {$force_conservative} {
        set send_slow {1 .1}
        proc send {ignore arg} {
                sleep .1
                exp_send -s -- $arg
        }
}

set timeout 30
spawn /bin/bash
match_max 100000
send -- "ssh $EQUALLOGIC_USER@$EQUALLOGIC_IP\r"

expect {
    "yes/no)?" {
                send "yes\r"
                set timeout -1
    } timeout {
                exit
    } -re . {
                exp_continue
    } eof {
                exit
    }
 }

expect -exact "password: "
send -- "$EQUALLOGIC_PASSWORD\r"
expect -exact ">"

# get access to volume
send -- "volume select $EQUALLOGIC_VOLUME\r"
expect -exact ">"
send -- "access delete $EQUALLOGIC_VOLUME_ACCESS_ID\r"
send -- "y\r"
expect -exact ">"
send -- "exit\r"

expect -exact ">"
send -- "logout\r"
send -- "\r"
expect {
    "Do you really want to logout? (y/n) \[n\]" {
        send -- "y\r"
    } "Connection to $EQUALLOGIC_IP closed." {
    } timeout {
        exit
    } eof {
        exit
    }
}



