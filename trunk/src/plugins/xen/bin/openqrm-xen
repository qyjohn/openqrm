#!/bin/bash

# this script automatically manages xen
OPENQRM_SERVER_BASE_DIR=$(dirname $0)/../../../..
OPENQRM_SERVER_BASE_DIR=$(pushd $OPENQRM_SERVER_BASE_DIR > /dev/null && echo $PWD && popd > /dev/null)
. $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/xen/include/openqrm-plugin-xen-functions
. /var/openqrm/openqrm-resource.conf
OPENQRM_POSTENCODE="$resource_basedir/openqrm/sbin/openqrm-postencode.py"

# let only root run this script
WHOAMI=`whoami`
if [ "$WHOAMI" != "root" ]; then
	echo "ERROR: Please run this script as root!"
	exit 6
fi

function xen_usage() {
	echo "Usage : $0 create/start/stop/reboot/kill/remove/list <-n vm-name>"
	echo "        $0 post_vm_list <-u username> <-p password>"
	exit 1
}


XEN_COMMAND=$1
shift

while [ $# -ne 0 ]; do
	case "$1" in
		-n)
			XEN_VM_NAME=$2
			shift
			;;
		-u)
			XEN_OPENQRM_USERNAME=$2
			shift
			;;
		-p)
			XEN_OPENQRM_PASSWORD=$2
			shift
			;;
		*)
			echo "ERROR: Free commandline arguments are not allowed"
			xen_usage
			exit 6
			;;
	esac
	shift
done




# main
if [ "$XEN_COMMAND" == "" ]; then
	xen_usage
fi

if [ "$XEN_COMMAND" == "post_vm_list" ]; then
		if [ "$XEN_OPENQRM_USERNAME" == "" ]; then
			xen_usage
		fi
		if [ "$XEN_OPENQRM_PASSWORD" == "" ]; then
			xen_usage
		fi
else

	if [ "$XEN_COMMAND" != "list" ]; then
		if [ "$XEN_VM_NAME" == "" ]; then
			xen_usage
		fi
	fi
fi


case "$XEN_COMMAND" in 

	create)
		echo "Creating Xen vm $XEN_VM_NAME"
		xm new /etc/xen/$XEN_VM_NAME.cfg
		;;
	start)
		echo "Starting Xen vm $XEN_VM_NAME"
		xm start $XEN_VM_NAME
		;;
	stop)
		echo "Stopping Xen vm $XEN_VM_NAME"
		xm shutdown $XEN_VM_NAME
		;;
	kill)
		echo "Force-stop Xen vm $XEN_VM_NAME"
		xm destroy $XEN_VM_NAME
		;;
	reboot)
		echo "Rebooting Xen vm $XEN_VM_NAME"
		xm reboot $XEN_VM_NAME
		;;
	remove)
		echo "Removing Xen vm $XEN_VM_NAME"
		xm delete $XEN_VM_NAME
		;;
	list)
		echo "Listing Xen vms"
		xm list
		;;
	post_vm_list)
		echo "Posting vm list to the openQRM-server"
		VM_LIST_TMP=$resource_id.vm_list
		xm list > $VM_LIST_TMP
		# add #'s at the beginning to make later parsing easier
		cat $VM_LIST_TMP | sed -e "s/^/#/g" > $VM_LIST_TMP.up
		mv -f $VM_LIST_TMP.up $VM_LIST_TMP
		echo "<br>Available inactive Xen vms :<br>" >> $VM_LIST_TMP
		for cfg in `ls /etc/xen/*.cfg`; do
			basename $cfg >> $VM_LIST_TMP
		done
		if ! wget -q -O /dev/null --http-user=$XEN_OPENQRM_USERNAME --http-password=$XEN_OPENQRM_PASSWORD  --post-file=`$OPENQRM_POSTENCODE $VM_LIST_TMP` http://$resource_openqrmserver/openqrm/base/plugins/11/xen-action.php?xen_command=get_xen; then
			echo "ERROR: Could not post vm list to the openQRM-server at $resource_openqrmserver!"
			echo "ERROR: Could not post vm list to the openQRM-server at $resource_openqrmserver!" | logger
		fi
		rm -f $VM_LIST_TMP
		rm -f $VM_LIST_TMP.post
		;;
	*)
		xen_usage
		;;


esac

