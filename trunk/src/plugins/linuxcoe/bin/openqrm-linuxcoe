#!/bin/bash
# this script provides a guided installation/uninstallation for linuxcoe

# get the openQRM functions
OPENQRM_SERVER_BASE_DIR=$(dirname $0)/../../../..
OPENQRM_SERVER_BASE_DIR=$(pushd $OPENQRM_SERVER_BASE_DIR > /dev/null && echo $PWD && popd > /dev/null)
OPENQRM_SOURCE_DIR=$OPENQRM_SERVER_BASE_DIR
export OPENQRM_SOURCE_DIR
. $OPENQRM_SERVER_BASE_DIR/openqrm/include/openqrm-functions
. $OPENQRM_SERVER_BASE_DIR/openqrm/include/openqrm-package-functions
. $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/linuxcoe/include/openqrm-plugin-linuxcoe-functions

LCOE_BASE_VERSION="4"
LCOE_SUB_VERSION="1"
SD_BASE_VERSION="4"
LCOE_BASE="linuxcoe-sd-$LCOE_BASE_VERSION.$LCOE_SUB_VERSION.tar.gz"
LCOE_DOCS="linuxcoe-sd-docs-$LCOE_BASE_VERSION.$LCOE_SUB_VERSION.tar.gz"
LCOE_DISTRIBUTIONS="centos debian fedora opensuse ubuntu"
LCOE_INSTALL_DIR="/usr/local/linuxcoe-sd"
LCOE_DOWNLOAD="http://www.instalinux.com/snapshots/"
LCOE_INSTALL_TMP="$OPENQRM_SERVER_BASE_DIR/openqrm/plugins/linuxcoe/lcoe-install"
CURRENT_DIR=`pwd`

# for debian we need the netinstaller images
DEB_NETINSTALLER_ETCH="http://http.us.debian.org/debian/dists/etch/main/installer-i386/current/images/netboot/netboot.tar.gz"
DEB_NETINSTALLER_LENNY="http://http.us.debian.org/debian/dists/lenny/main/installer-i386/current/images/netboot/netboot.tar.gz"

# for centos we need the pxeboot images
CENTOS4_NETINSTALLER_KERNEL="http://linux.mirrors.es.net/centos/4/os/i386/images/pxeboot/vmlinuz"
CENTOS4_NETINSTALLER_INITRD="http://linux.mirrors.es.net/centos/4/os/i386/images/pxeboot/initrd.img"
CENTOS5_NETINSTALLER_KERNEL="http://linux.mirrors.es.net/centos/5/os/i386/images/pxeboot/vmlinuz"
CENTOS5_NETINSTALLER_INITRD="http://linux.mirrors.es.net/centos/5/os/i386/images/pxeboot/initrd.img"

if ! which screen 1>/dev/null; then
	linuxcoe_log "ERROR: The 'screen' utility is not installed! Please install and try again."
	exit 6
fi

# re-run in background via screen
if [ "$RUN_IN_BACKGROUND" != "true" ]; then
	export RUN_IN_BACKGROUND=true
	SCREEN_NAME=`date +%T%x | sed -e "s/://g" | sed -e "s#/##g"`
	screen -dmS $SCREEN_NAME $0 $@
	exit	
fi



function lcoe_download_if_needed() {
	FULL_URL=$1
	RESULT_FILENAME=$2
	if [ "$RESULT_FILENAME" != "" ]; then
		PACKAGE=$RESULT_FILENAME
	else
		PACKAGE=`basename $FULL_URL`
	fi
	mkdir -p $LCOE_INSTALL_TMP/download
	if [ ! -f $LCOE_INSTALL_TMP/download/$PACKAGE ]; then
		linuxcoe_log "> $LCOE_INSTALL_TMP/download/$PACKAGE does not yet exists, attempting download .."
		if wget -O $LCOE_INSTALL_TMP/download/$PACKAGE $FULL_URL; then
			linuxcoe_log "> Downloaded $PACKAGE"
		else
			linuxcoe_log "! Download of $PACKAGE failed !"
			linuxcoe_log "Please put the $PACKAGE file at $LCOE_INSTALL_TMP/download/ and try again."
			linuxcoe_lock release
			exit 1
		fi
	else
		linuxcoe_log "> $PACKAGE already available at $LCOE_INSTALL_TMP/download/. Skipping download"
	fi

}



function lco_prepare() {

	# install os deps autoconf, automake, perl
	openqrm_install_os_dependency autoconf
	openqrm_install_os_dependency automake
	#openqrm_install_os_dependency perl

	# download needed ?
	lcoe_download_if_needed $LCOE_DOWNLOAD/$LCOE_BASE
	for DIST in $LCOE_DISTRIBUTIONS; do
		lcoe_download_if_needed $LCOE_DOWNLOAD/systemdesigner-$DIST-$SD_BASE_VERSION.tar.gz
		lcoe_download_if_needed $LCOE_DOWNLOAD/linuxcoe-sd-data-$DIST-$LCOE_BASE_VERSION.$LCOE_SUB_VERSION.tar.gz
	done

	# unpack
	mkdir -p $LCOE_INSTALL_TMP/install
	if [ ! -d $LCOE_INSTALL_TMP/install/linuxcoe-sd-$LCOE_BASE_VERSION.$LCOE_SUB_VERSION ]; then
		tar -C $LCOE_INSTALL_TMP/install -xzf $LCOE_INSTALL_TMP/download/$LCOE_BASE
	fi
	for DIST in $LCOE_DISTRIBUTIONS; do
		if [ ! -d $LCOE_INSTALL_TMP/install/systemdesigner-$DIST-$SD_BASE_VERSION ]; then
			tar -C  $LCOE_INSTALL_TMP/install -xzf $LCOE_INSTALL_TMP/download/systemdesigner-$DIST-$SD_BASE_VERSION.tar.gz
		fi
		if [ ! -d $LCOE_INSTALL_TMP/install/linuxcoe-sd-data-$DIST-$LCOE_BASE_VERSION.$LCOE_SUB_VERSION ]; then
			tar -C  $LCOE_INSTALL_TMP/install -xzf $LCOE_INSTALL_TMP/download/linuxcoe-sd-data-$DIST-$LCOE_BASE_VERSION.$LCOE_SUB_VERSION.tar.gz
		fi
	done

	# debian netinstallers
	lcoe_download_if_needed $DEB_NETINSTALLER_ETCH netboot-etch.tar.gz
	lcoe_download_if_needed $DEB_NETINSTALLER_LENNY netboot-lenny.tar.gz
	mkdir -p $LCOE_INSTALL_TMP/install/debian/etch $LCOE_INSTALL_TMP/install/debian/lenny
	tar -C  $LCOE_INSTALL_TMP/install/debian/etch -xzf $LCOE_INSTALL_TMP/download/netboot-etch.tar.gz
	tar -C  $LCOE_INSTALL_TMP/install/debian/lenny -xzf $LCOE_INSTALL_TMP/download/netboot-lenny.tar.gz
	/bin/cp -aR $LCOE_INSTALL_TMP/install/debian $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/linuxcoe/etc/

	# centos pxeboot images
	lcoe_download_if_needed $CENTOS4_NETINSTALLER_KERNEL vmlinuz-centos4
	lcoe_download_if_needed $CENTOS4_NETINSTALLER_INITRD initrd-centos4.img
	lcoe_download_if_needed $CENTOS5_NETINSTALLER_KERNEL vmlinuz-centos5
	lcoe_download_if_needed $CENTOS5_NETINSTALLER_INITRD initrd-centos5.img
	mkdir -p $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/linuxcoe/etc/centos/4 $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/linuxcoe/etc/centos/5
	/bin/cp -f $LCOE_INSTALL_TMP/download/vmlinuz-centos4 $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/linuxcoe/etc/centos/4/
	/bin/cp -f $LCOE_INSTALL_TMP/download/initrd-centos4.img $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/linuxcoe/etc/centos/4/
	/bin/cp -f $LCOE_INSTALL_TMP/download/vmlinuz-centos5 $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/linuxcoe/etc/centos/5/
	/bin/cp -f $LCOE_INSTALL_TMP/download/initrd-centos5.img $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/linuxcoe/etc/centos/5/


}



function lcoe_install() {
	lco_prepare
	linuxcoe_log "> Installing LinuxCOE base"
	cd $LCOE_INSTALL_TMP/install/linuxcoe-sd-$LCOE_BASE_VERSION.$LCOE_SUB_VERSION
	if [ ! -f $LCOE_INSTALL_TMP/install/linuxcoe-sd-$LCOE_BASE_VERSION.$LCOE_SUB_VERSION/Makefile ]; then
		./autogen.sh 2>&1 | tee -a /var/log/messages
		export CONFIG_SITE="./config.site"
		if ! ./configure  2>&1 | tee -a /var/log/messages; then
			linuxcoe_log "! Error during configure of LinuxCOE. Please check the requirements !"
			linuxcoe_lock release
			exit 1
		fi
	fi
	make  2>&1 | tee -a /var/log/messages
	make install  2>&1 | tee -a /var/log/messages
	make integrate  2>&1 | tee -a /var/log/messages

	for DIST in $LCOE_DISTRIBUTIONS; do
		linuxcoe_log "> Installing systemdesigner-$DIST"
		cd $LCOE_INSTALL_TMP/install/systemdesigner-$DIST-$SD_BASE_VERSION
		export CONFIG_SITE="$LCOE_INSTALL_DIR/etc/includes/config.state"
		./configure  2>&1 | tee -a /var/log/messages
		make  2>&1 | tee -a /var/log/messages
		make install  2>&1 | tee -a /var/log/messages
		linuxcoe_log "> Installing linuxcoe-sd-data-$DIST"
		cd $LCOE_INSTALL_TMP/install/linuxcoe-sd-data-$DIST-$LCOE_BASE_VERSION.$LCOE_SUB_VERSION
		./configure --prefix=$LCOE_INSTALL_DIR  2>&1 | tee -a /var/log/messages
		make  2>&1 | tee -a /var/log/messages
		make install 2>&1 | tee -a /var/log/messages
	done

	cd $CURRENT_DIR
	linuxcoe_log "> Installation of LinuxCOE finished successfully"
}


function lcoe_uninstall() {
	linuxcoe_log "> Un-installing LinuxCOE"
	if [ ! -d $LCOE_INSTALL_TMP/install/linuxcoe-sd-$LCOE_BASE_VERSION.$LCOE_SUB_VERSION ]; then
		linuxcoe_log "! LinuxCOE base install directory does not exist."
		if [ ! -f $LCOE_INSTALL_TMP/download/$LCOE_BASE ]; then
			lcoe_download_if_needed $LCOE_DOWNLOAD/$LCOE_BASE
		else
			linuxcoe_log "> Found $LCOE_BASE at $LCOE_INSTALL_TMP/download/, just unpacking it."
		fi
		mkdir -p $LCOE_INSTALL_TMP/install
		tar -C $LCOE_INSTALL_TMP/install -xzf $LCOE_INSTALL_TMP/download/$LCOE_BASE
	fi
	rm -f /etc/apache2/conf.d/LinuxCOE-SystemDesigner.conf
	cd $LCOE_INSTALL_TMP/install/linuxcoe-sd-$LCOE_BASE_VERSION.$LCOE_SUB_VERSION
	if [ ! -f $LCOE_INSTALL_TMP/install/linuxcoe-sd-$LCOE_BASE_VERSION.$LCOE_SUB_VERSION/Makefile ]; then
		./autogen.sh  2>&1 | tee -a /var/log/messages
		export CONFIG_SITE="./config.site"
		if ! ./configure  2>&1 | tee -a /var/log/messages; then
			linuxcoe_log "! Error during configure of LinuxCOE. Please check the requirements !"
			linuxcoe_lock release
			exit 1
		fi
	fi
	make uninstall  2>&1 | tee -a /var/log/messages
	rm -rf /usr/local/linuxcoe-sd
	rm -rf /etc/linuxcoe-sd
	cd $CURRENT_DIR
	linuxcoe_log "> Uninstallation of LinuxCOE finished successfully"
	linuxcoe_log "> (You may want to run \"$0 clean\" to remove the temporary files and directories)"
}



function lcoe_clean() {
	linuxcoe_log "> Cleaning temporary downloads and install directories"
	rm -rf $LCOE_INSTALL_TMP/install/*
#	rm -rf $LCOE_INSTALL_TMP/download/*
}


case "$1" in
	install)
		linuxcoe_lock aquire
		lcoe_uninstall
		lcoe_install
		linuxcoe_lock release
		;;
	uninstall)
		linuxcoe_lock aquire
		lcoe_uninstall
		linuxcoe_lock release
		;;
	clean)
		linuxcoe_lock aquire
		lcoe_clean
		linuxcoe_lock release
		;;
	prepare)
		linuxcoe_lock aquire
		lco_prepare
		linuxcoe_lock release
		;;
        *)
        echo $"Usage: $0 {install|uninstall|clean|prepare}"
        exit 1
		;;
esac



