#!/bin/bash

# this script automatically manages citrix
OPENQRM_SERVER_BASE_DIR=$(dirname $0)/../../../..
OPENQRM_SERVER_BASE_DIR=$(pushd $OPENQRM_SERVER_BASE_DIR > /dev/null && echo $PWD && popd > /dev/null)
. $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/citrix/etc/openqrm-plugin-citrix.conf
. $OPENQRM_SERVER_BASE_DIR/openqrm/include/openqrm-functions
. $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/citrix/include/openqrm-plugin-citrix-functions
. $OPENQRM_SERVER_BASE_DIR/openqrm/etc/openqrm-server.conf
. $OPENQRM_SERVER_BASE_DIR/openqrm/include/openqrm-server-functions
openqrm_server_get_config
export LANG=C
export resource_openqrmserver=$OPENQRM_SERVER_IP_ADDRESS


# let only root run this script
WHOAMI=`whoami`
if [ "$WHOAMI" != "root" ]; then
	echo "ERROR: Please run this script as root!"
	exit 6
fi

function citrix_usage() {
	echo "Usage : $0 start/stop/reboot/list <-s citrix-server-ip> <-n vm-uuid>"
	echo "        $0 vm-mem-set <-s citrix-server-ip> <-n vm-uuid> <-m ram>"
	echo "        $0 create <-s citrix-server-ip> <-l vm-name> <-m ram>"
	echo "        $0 post_vm_list <-s citrix-server-ip>"
	exit 1
}


CITRIX_COMMAND=$1
shift

while [ $# -ne 0 ]; do
	case "$1" in
		-n)
			CITRIX_VM_UUID=$2
			shift
			;;
		-s)
			CITRIX_SERVER_IP=$2
			shift
			;;
		-l)
			CITRIX_VM_NAME=$2
			shift
			;;
		-m)
			CITRIX_VM_RAM=$2
			shift
			;;
		*)
			echo "ERROR: Free commandline arguments are not allowed"
			citrix_usage
			exit 6
			;;
	esac
	shift
done


# main
if [ "$CITRIX_COMMAND" == "" ]; then
	citrix_usage
fi

if [ "$CITRIX_COMMAND" != "list" ] && [ "$CITRIX_COMMAND" != "post_vm_list" ] && [ "$CITRIX_COMMAND" != "create" ]; then
	if [ "$CITRIX_VM_UUID" == "" ]; then
		citrix_usage
	fi
fi
if [ "$CITRIX_SERVER_IP" == "" ]; then
	citrix_usage
fi

CITRIX_SERVER_PASSWD_FILE=$OPENQRM_SERVER_BASE_DIR/openqrm/plugins/citrix/web/citrix-stat/citrix-host.pwd.$CITRIX_SERVER_IP
CITRIX_VM_LIST_TMP=$OPENQRM_SERVER_BASE_DIR/openqrm/plugins/citrix/web/citrix-stat/citrix-vm.lst.$CITRIX_SERVER_IP
mkdir -p `dirname $CITRIX_VM_LIST_TMP`
chmod 777 `dirname $CITRIX_VM_LIST_TMP`

if [ ! -f $CITRIX_SERVER_PASSWD_FILE ]; then
	citrix_log openqrm-citrix "No password file ($CITRIX_SERVER_PASSWD_FILE) existing for Citrix host $CITRIX_SERVER_IP"
	openqrm_post_event 0 "$CITRIX_COMMAND" 3 "openqrm-citrix" "No password file ($CITRIX_SERVER_PASSWD_FILE) existing for Citrix host $CITRIX_SERVER_IP"
	exit 1
fi

case "$CITRIX_COMMAND" in 

	start)
		echo "Starting Citrix vm $CITRIX_VM_UUID"
		$CITRIX_XE_BINARY vm-start -s $CITRIX_SERVER_IP -pwf $CITRIX_SERVER_PASSWD_FILE uuid=$CITRIX_VM_UUID
		;;
	stop)
		echo "Stopping Citrix vm $CITRIX_VM_UUID"
		$CITRIX_XE_BINARY vm-stop -s $CITRIX_SERVER_IP -pwf $CITRIX_SERVER_PASSWD_FILE uuid=$CITRIX_VM_UUID
		;;
	list)
		echo "Listing Citrix vms"
		$CITRIX_XE_BINARY vm-list -s $CITRIX_SERVER_IP -pwf $CITRIX_SERVER_PASSWD_FILE
		;;
	post_vm_list)
		echo "Posting vm list to the openQRM-server"
		$CITRIX_XE_BINARY vm-list -s $CITRIX_SERVER_IP -pwf $CITRIX_SERVER_PASSWD_FILE > $CITRIX_VM_LIST_TMP
		;;
	# Some Additions
	vm-reboot)
		echo "reboot Citrix vms"
		$CITRIX_XE_BINARY vm-reboot -s $CITRIX_SERVER_IP -pwf $CITRIX_SERVER_PASSWD_FILE uuid=$CITRIX_VM_UUID
		;;
	create)
		if [ "$CITRIX_VM_NAME" == "" ]; then
			citrix_usage
		fi
		if [ "$CITRIX_VM_RAM" == "" ]; then
			citrix_usage
		fi
		echo "Creating Citrix vm $CITRIX_VM_NAME"
       	$CITRIX_XE_BINARY -s $CITRIX_SERVER_IP -pwf $CITRIX_SERVER_PASSWD_FILE vm-install new-name-label="$CITRIX_VM_NAME"
       	# Find the network associated with the management interface. We'll assume that{_}{color}
		# this is the network on which we want a network interface._{color}
		NETWORK=`$CITRIX_XE_BINARY -s $CITRIX_SERVER_IP -pwf $CITRIX_SERVER_PASSWD_FILE network-list bridge=${CITRIX_MANAGEMENT_INTERFACE} --minimal` 
        # Add a VIF linking the VM to the network
        $CITRIX_XE_BINARY -s $CITRIX_SERVER_IP -pwf $CITRIX_SERVER_PASSWD_FILE vif-create vm-uuid=$CITRIX_VM_UUID network-uuid=${NETWORK} device=0
        #change boot order to netbooting
        $CITRIX_XE_BINARY -s $CITRIX_SERVER_IP -pwf $CITRIX_SERVER_PASSWD_FILE vm-param-set uuid=$CITRIX_VM_UUID HVM-boot-params:order=ncd
		# Please add RAM-SIZE-Variable - get from gui
		$CITRIX_XE_BINARY -s $CITRIX_SERVER_IP -pwf $CITRIX_SERVER_PASSWD_FILE vm-param-set UUUID=$CITRIX_VM_UUID param-name=memory-static-max:$CITRIX_VM_RAM
         ;;
    vm-mem-set)
		if [ "$CITRIX_VM_RAM" == "" ]; then
			citrix_usage
		fi
		echo "Editing RAM of Citrix vms to $CITRIX_VM_RAM"  
		# Please check in future for ram - open bug
		# $CITRIX_XE_BINARY -s $CITRIX_SERVER_IP -pwf $CITRIX_SERVER_PASSWD_FILE host-param-get UUUID=$HOST-UUID param-name=memory-free
		# Please add RAM-SIZE-Variable - get from gui
		$CITRIX_XE_BINARY -s $CITRIX_SERVER_IP -pwf $CITRIX_SERVER_PASSWD_FILE vm-param-set UUUID=$CITRIX_VM_UUID param-name=memory-static-max:$CITRIX_VM_RAM
		;;
	host-reboot)
		echo "Rebooting Citrix Host"  
		# $CITRIX_XE_BINARY host-reboot UUID=$HOST-UUID
		# we need the host-uuid!
		;;
	*)
		citrix_usage
		;;


esac

