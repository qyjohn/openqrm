#!/bin/bash

# this script automatically manages citrix
OPENQRM_SERVER_BASE_DIR=$(dirname $0)/../../../..
OPENQRM_SERVER_BASE_DIR=$(pushd $OPENQRM_SERVER_BASE_DIR > /dev/null && echo $PWD && popd > /dev/null)
. $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/citrix/include/openqrm-functions
. $OPENQRM_SERVER_BASE_DIR/openqrm/plugins/citrix/include/openqrm-plugin-citrix-functions
CITRIX_VM_LIST_TMP=$OPENQRM_SERVER_BASE_DIR/openqrm/plugins/citrix/web/citrix-stat/citrix-vm.lst

# let only root run this script
WHOAMI=`whoami`
if [ "$WHOAMI" != "root" ]; then
	echo "ERROR: Please run this script as root!"
	exit 6
fi

function citrix_usage() {
	echo "Usage : $0 start/stop/list <-n vm-uuid>"
	echo "        $0 post_vm_list"
	exit 1
}


CITRIX_COMMAND=$1
shift

while [ $# -ne 0 ]; do
	case "$1" in
		-n)
			CITRIX_VM_UUID=$2
			shift
			;;
		*)
			echo "ERROR: Free commandline arguments are not allowed"
			citrix_usage
			exit 6
			;;
	esac
	shift
done




# main
if [ "$CITRIX_COMMAND" == "" ]; then
	citrix_usage
fi

if [ "$CITRIX_COMMAND" != "list" ] && [ "$CITRIX_COMMAND" != "post_vm_list" ]; then
	if [ "$CITRIX_VM_UUID" == "" ]; then
		citrix_usage
	fi
fi


case "$CITRIX_COMMAND" in 

	start)
		echo "Starting Citrix vm $CITRIX_VM_UUID"
		$CITRIX_XE_BINARY start uuid=$CITRIX_VM_UUID
		;;
	stop)
		echo "Stopping Citrix vm $CITRIX_VM_UUID"
		$CITRIX_XE_BINARY vm-shutdown uuid=$CITRIX_VM_UUID
		;;
	list)
		echo "Listing Citrix vms"
		$CITRIX_XE_BINARY vm-list
		;;
	post_vm_list)
		echo "Posting vm list to the openQRM-server"
		mkdir -p `dirname $CITRIX_VM_LIST_TMP`
		chmod 777 `dirname $CITRIX_VM_LIST_TMP`
		$CITRIX_XE_BINARY list > $CITRIX_VM_LIST_TMP
		;;
	*)
		citrix_usage
		;;


esac

